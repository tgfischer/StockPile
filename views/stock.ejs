
<!DOCTYPE html>
<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">

  <!-- Site Properties -->
  <title>Stock Pile</title>
  <link rel="stylesheet" type="text/css" href="/semantic/semantic.min.css">
  <link rel="stylesheet" type="text/css" href="/css/styles.css">
  <link rel="stylesheet" type="text/css" href="/css/stock.css">
</head>
<body class="light-text">
  <% include common/mobile-nav %>

  <!-- Page Contents -->
  <div class="pusher">
    <div class="ui inverted vertical segment">
      <% include common/nav %>
    </div>
    <div class="ui main vertical inverted stripe segment">
      <div class="ui middle aligned stackable grid container">
        <div class="row">
          <div class="column">
            <div class="ui inverted breadcrumb">
              <i class="left chevron icon divider"></i>
              <a href="/" class="section">Back</a>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="title column">
            <h1 class="ui huge inverted header">
              <%= company.name %>
              <div class="sub header">Symbol: <%= company.symbol %></div>
            </h1>
          </div>
        </div>
        <% if (user) { %>
          <div class="row">
            <div class="two wide column">
              <button class="ui fluid green inverted buy button">Buy</button>
            </div>
            <div class="two wide column">
              <button class="ui <% if (!user.stocks.filter(function(stock) { return stock.company._id === company._id }).length == 0) { %>disabled<% } %> fluid secondary inverted sell button">
                Sell
              </button>
            </div>
          </div>
        <% } %>
        <div class="row">
          <div class="title column">
            <div id="graph-loader" class="ui big text active loader">Analyzing News...</div>
            <canvas class="chart"></canvas>
          </div>
        </div>
      </div>
    </div>
<<<<<<< HEAD
    <% include common/footer %>
=======
>>>>>>> dd3b0fc13cecb77436fc73346bb7c1748c7cf477
  </div>
  <% include common/buySellStocks %>
  <script>
    // The following converts the "company" variable which this page is specific for, into a JavaScript variable to be used in the script.
    function htmlDecode(input){
      var e = document.createElement('div');
      e.innerHTML = input;
      return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }
    var comp = JSON.parse(htmlDecode("<%= JSON.stringify(company) %>"));
  </script>
  <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script type="text/javascript" language="javascript" src="/semantic/semantic.min.js"></script>
  <script type="text/javascript" language="javascript" src="/js/chart.min.js"></script>
  <script>
  $(document).ready(function() {
    // create sidebar and attach to menu open
    $('.ui.sidebar').sidebar('attach events', '.toc.item');

    <% if (user) { %>
      var user = <%- JSON.stringify(user) %>;
    <% } else { %>
      var user = null;
    <% } %>

    var companyObj = <%- JSON.stringify(company) %>

    <% include common/buySellStocksScripts %>

    // Make request to server for the
    Chart.defaults.global.defaultFontColor = "#FFFFFF";
    Chart.defaults.global.defaultFontSize = 15;

    // First thing we should do is check this company's "lastUpdated" field. If it is more than a day old, we should redo the 
    // sentiment query and add recent results. When result is true, we need to get more sentiment results.
    consultLastUpdated(comp, function() {
      renderGraphData(comp, function(renderData) {
        var ctx = $('.chart');
        var chart = Chart.Line(ctx, {
          data: {
            datasets: [{
              label: 'Scatter Dataset',
              fill: true,
              borderColor: 'rgba(183, 28, 28, 1)',
              pointBorderColor: 'rgba(239, 83, 80, 1)',
              pointBackgroundColor: 'rgba(239, 83, 80, 1)',
              data: renderData
            }]
          },
          options: {
            lineTension: 0,
            animation: false,
            scales: {
              xAxes: [{
                type: 'linear',
                position: 'bottom',
                gridLines: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  zeroLineColor: 'rgba(255, 255, 255, 0.15)'
                }
              }],
              yAxes: [{
                gridLines: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  zeroLineColor: 'rgba(255, 255, 255, 0.15)'
                }
              }]
            },
            legend: {
              display: false
            }
          }
        });
      });   // end renderGraphData callback
    });     // end consultLastUpdated callback   
  });       // end document ready

  function consultLastUpdated(comp, callback) {
    var update = false;
    var lastUpdated = comp.lastUpdated;
    if (!lastUpdated) {
      update = true; // lastUpdated will be null if we have never updated the sentiment results
    } else {
      lastUpdated = new Date(lastUpdated);
      // If lastUpdated exists, we must compare it with the current time. If time > 1 day, return true to get some new results
      var currentDate = new Date();

      var timeDiff = Math.abs(currentDate.getTime() - lastUpdated.getTime());
      var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24)); 
      
      if (diffDays > 1) {
        update = true;
      } else {
        update = false;
      }
    }

    if (update) {
      $.ajax({
        url: "/stock/sentiment/" + comp._id,
        method: "GET",
        success: function(data) {
          $("#graph-loader").removeClass("active");
          callback();
        }
      });
    } else {
      // We should update the finance stats 
      $.ajax({
        url: "/stockprice/"+comp._id,
        method: "GET",
        success: function(data) {
          console.log("Updated stock price and percent change!");
        }
      });
      $("#graph-loader").removeClass("active");
      callback();
    }
  }

  function renderGraphData(comp, callback) {
    $.ajax({
      url:"/stock/update/" + comp.symbol,
      method: "GET",
      success: function(newCompany) {
        $.ajax({
          url: "/stock/sentiment",
          method: "POST",
          data: {
            sentiments: newCompany.sentiments
          }, 
          success: function (sentiments) {
            var company_data = []; 
            
            // Do a for loop here
            for (var i = 0; i < sentiments.length; i++) {
              var temp = {
                x: i,
                y: sentiments[i].score
              };
              company_data.push(temp);
            }
            callback(company_data);
          }
        });
      }
    });
  }
  </script>

</body>

</html>
